module.exports=[43739,e=>{"use strict";var t=e.i(47909),a=e.i(74017),n=e.i(96250),s=e.i(59756),r=e.i(61916),o=e.i(74677),i=e.i(69741),l=e.i(16795),u=e.i(87718),c=e.i(95169),d=e.i(47587),p=e.i(66012),g=e.i(70101),m=e.i(26937),f=e.i(10372),h=e.i(93695);e.i(52474);var v=e.i(5232);let y=(0,e.i(24389).createClient)("https://example.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),w={main:"echo",echo:"echo",scout:"scout",quill:"quill",sage:"sage",sentinel:"sentinel",xalt:"xalt"},_={echo:"meeting",scout:"research",quill:"research",sage:"board",sentinel:"board",xalt:"research"},R={echo:"meeting",scout:"meeting",quill:"meeting",sage:"meeting",sentinel:"board",xalt:"board"};function b(e){return _[e]||"research"}let k={scout:[/pixel/i,/ui\/ux/i,/design/i,/layout/i],quill:[/dash/i,/frontend/i,/html/i,/css/i,/react/i,/component/i],sage:[/stack/i,/backend/i,/api/i,/server/i,/database/i],sentinel:[/probe/i,/qa/i,/bug/i,/test/i,/quality/i],xalt:[/ship/i,/devops/i,/deploy/i,/ci\/cd/i,/infra/i]},x=new Map;async function E(e){if(e&&/assign|delegat|send|dispatc|task.*to|asking|telling/i.test(e))for(let[t,a]of Object.entries(k)){let n=w[t]||t;if(a.some(t=>t.test(e))){let t=e.match(RegExp(`(?:${a.map(e=>e.source).join("|")}).*?[—–\\-:]\\s*(.{10,80})`,"i")),s=t?t[1].slice(0,80):"Working on delegated task";x.set(n,{startedAt:Date.now(),task:s}),await y.from("ops_agents").update({status:"working",current_task:s,current_room:b(n),last_active_at:new Date().toISOString()}).eq("name",n),await y.from("ops_events").insert({agent:n,event_type:"task",title:`Delegated by Echo: ${s.slice(0,60)}`})}}}async function C(){for(let[e,t]of x.entries())await y.from("ops_agents").update({status:"idle",current_task:null,current_room:"desk",last_active_at:new Date().toISOString()}).eq("name",e),await y.from("ops_events").insert({agent:e,event_type:"complete",title:"Completed delegated task"});x.clear()}let S=new Map,A=null;A=setInterval(async()=>{let e=Date.now();for(let[t,a]of S.entries()){if(a.recovered)continue;let n=e-a.startedAt;n>12e4&&(a.recovered=!0,console.log(`[Watchdog] Run ${t} timed out after ${Math.round(n/1e3)}s`),await y.from("ops_agents").update({status:"idle",current_task:null,current_room:"desk",last_active_at:new Date().toISOString()}).eq("name",a.agent),await y.from("ops_events").insert({agent:a.agent,event_type:"alert",title:`Run timed out after ${Math.round(n/1e3)}s`}),setTimeout(()=>S.delete(t),5e3))}},15e3);let q={desk:["desk","desks","dev floor","devfloor","work"],meeting:["meeting","standup","stand up","stand-up","huddle","social","chat","chat room","lounge"],research:["research","lab","code lab","codelab"],board:["board","sprint","sprint board","sprintboard","kanban","break","coffee"]},O={echo:"echo",pixel:"scout",dash:"quill",stack:"sage",probe:"sentinel",ship:"xalt",scout:"scout",quill:"quill",sage:"sage",sentinel:"sentinel",xalt:"xalt"},I=["everyone","all","team","all agents","everybody","guys","y'all","yall"];async function T(e){if(!e)return null;let t=e.toLowerCase().trim();if(!/(?:come|go|move|head|get|walk|report)\s+(?:to|over\s+to|into|in)?\s*/i.test(t)&&!/(?:go\s+to|come\s+to|move\s+to|head\s+to|report\s+to|get\s+to|walk\s+to)\s+/i.test(t))return null;let a=null;for(let[e,n]of Object.entries(q)){for(let s of n)if(t.includes(s)){a=e;break}if(a)break}if(!a)return null;let n=[];if(I.some(e=>t.includes(e)))n=["echo","scout","quill","sage","sentinel","xalt"];else for(let[e,a]of Object.entries(O))t.includes(e)&&!n.includes(a)&&n.push(a);if(0===n.length)return null;for(let e of n)await y.from("ops_agents").update({current_room:a}).eq("name",e);return{agents:n,room:a}}let $=["scout","quill","sage","sentinel","xalt"],P=["roll call","rollcall","team report","status report","team check","everyone report","all agents","team standup","standup","check in","who's here","whos here","who is here","sound off","report in"],D={pixel:"scout",dash:"quill",stack:"sage",probe:"sentinel",ship:"xalt"};async function N(e){try{if("node:connected"===e.type||"node:disconnected"===e.type)return await y.from("ops_events").insert({agent:"system",event_type:"system",title:"node:connected"===e.type?"Bridge connected to gateway":`Bridge disconnected (${e.message||""})`}),{type:e.type};if("event"!==e.type)return null;let t=e.event,a=e.payload||{},n=function(e){if(e?.agentId&&w[e.agentId])return w[e.agentId];if(e?.sessionKey){let t=e.sessionKey.split(":");if("agent"===t[0]&&w[t[1]])return w[t[1]]}return e?.data?.agentId&&w[e.data.agentId]?w[e.data.agentId]:null}(a)||"echo",s=a.runId;if("agent"===t&&"lifecycle"===a.stream&&a.data?.phase==="start"){let e=a.sessionKey?.includes("subagent");return s&&S.set(s,{agent:n,text:"",startedAt:Date.now(),toolCalls:[],chatLogged:!1,recovered:!1,isSubagent:e}),await y.from("ops_agents").update({status:"working",current_task:e?"Working on delegated sub-task...":"Processing request...",current_room:b(n),last_active_at:new Date().toISOString()}).eq("name",n),await y.from("ops_events").insert({agent:n,event_type:"task",title:e?"Sub-agent started working":"Started processing request"}),{type:"lifecycle_start",agent:n,isSubagent:e}}if("agent"===t&&"lifecycle"===a.stream&&a.data?.phase==="end"){let e=s?S.get(s):null,t=e?.isSubagent||a.sessionKey?.includes("subagent");return e?.text&&await y.from("ops_messages").insert({from_agent:n,to_agent:"user",message:e.text.slice(0,1500)}),await y.from("ops_agents").update({status:"idle",current_task:null,current_room:"desk",last_active_at:new Date().toISOString()}).eq("name",n),await y.from("ops_events").insert({agent:n,event_type:"complete",title:`Completed${e?.toolCalls.length?` (${e.toolCalls.length} tools used)`:""}`}),t&&await C(),s&&setTimeout(()=>S.delete(s),5e3),{type:"lifecycle_end",agent:n,isSubagent:t}}if("agent"===t&&"assistant"===a.stream){let e=a.data?.text||"";if(!e)return null;if(s){let t=S.get(s);t&&(t.text=e)}let t=e.length>80?e.slice(0,80)+"...":e;return await y.from("ops_agents").update({status:"talking",current_task:`Responding: "${t}"`,current_room:R[n]||"social",last_active_at:new Date().toISOString()}).eq("name",n),"echo"===n&&await E(e),{type:"assistant_stream",agent:n}}if("agent"===t&&"tool-call"===a.stream){let e=a.data?.name||a.data?.tool||"unknown";if(s){let t=S.get(s);t&&t.toolCalls.push(e)}return await y.from("ops_agents").update({status:"working",current_task:`Using: ${e}`,current_room:b(n),last_active_at:new Date().toISOString()}).eq("name",n),await y.from("ops_events").insert({agent:n,event_type:"task",title:`Tool: ${e}`}),{type:"tool_call",agent:n,tool:e}}if("agent"===t&&"tool-result"===a.stream)return await y.from("ops_events").insert({agent:n,event_type:"complete",title:"Tool result received"}),{type:"tool_result",agent:n};if("chat"===t){let e=s?S.get(s):null;if(e?.chatLogged)return null;e&&(e.chatLogged=!0);let t=a.data?.text||a.text||a.content||"",r=await T(t);r&&await y.from("ops_events").insert({agent:"system",event_type:"move",title:`${r.agents.join(", ")} → ${r.room}`});let o=function(e){if(!e)return null;let t=e.toLowerCase().trim();if(P.some(e=>t.includes(e)))return{type:"team",agents:$};for(let[e,a]of Object.entries(D))if([`@${e}`,`hey ${e}`,`yo ${e}`,`${e},`].some(e=>t.includes(e)))return{type:"single",agents:[a]};return null}(t);return o&&await y.from("ops_events").insert({agent:"system",event_type:"dispatch",title:`Dispatching ${o.type}: ${o.agents.join(", ")}`}),t&&await y.from("ops_messages").insert({from_agent:"user",to_agent:n,message:t.slice(0,1500)}),await y.from("ops_events").insert({agent:n,event_type:"chat",title:`Message: ${(t||"...").slice(0,80)}`}),{type:"chat",agent:n}}return null}catch(e){return console.error("[Bridge] Error:",e.message),null}}async function j(){return Response.json({status:"ready",gateway:process.env.OPENCLAW_GATEWAY_URL||"ws://localhost:18789",agents:[...new Set(Object.values(w))],activeRuns:S.size,timestamp:new Date().toISOString()})}async function U(e){try{let t=await e.json();if(t.type&&!t.events){let e=await N(t);return Response.json({ok:!0,processed:+!!e,result:e})}if(Array.isArray(t.events)){let e=[];for(let a of t.events){let t=await N(a);t&&e.push(t)}return Response.json({ok:!0,processed:e.length,results:e})}return Response.json({ok:!1,error:"Invalid payload"},{status:400})}catch(e){return console.error("[Bridge API] Error:",e.message),Response.json({ok:!1,error:e.message},{status:500})}}e.s(["GET",()=>j,"POST",()=>U],70618);var H=e.i(70618);let M=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/gateway-bridge/route",pathname:"/api/gateway-bridge",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/gateway-bridge/route.js",nextConfigOutput:"",userland:H}),{workAsyncStorage:K,workUnitAsyncStorage:L,serverHooks:B}=M;function F(){return(0,n.patchFetch)({workAsyncStorage:K,workUnitAsyncStorage:L})}async function W(e,t,n){M.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/gateway-bridge/route";y=y.replace(/\/index$/,"")||"/";let w=await M.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:_,params:R,nextConfig:b,parsedUrl:k,isDraftMode:x,prerenderManifest:E,routerServerContext:C,isOnDemandRevalidate:S,revalidateOnlyGenerated:A,resolvedPathname:q,clientReferenceManifest:O,serverActionsManifest:I}=w,T=(0,i.normalizeAppPath)(y),$=!!(E.dynamicRoutes[T]||E.routes[q]),P=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,k,!1):t.end("This page could not be found"),null);if($&&!x){let e=!!E.routes[q],t=E.dynamicRoutes[T];if(t&&!1===t.fallback&&!e){if(b.experimental.adapterPath)return await P();throw new h.NoFallbackError}}let D=null;!$||M.isDev||x||(D="/index"===(D=q)?"/":D);let N=!0===M.isDev||!$,j=$&&!N;I&&O&&(0,o.setManifestsSingleton)({page:y,clientReferenceManifest:O,serverActionsManifest:I});let U=e.method||"GET",H=(0,r.getTracer)(),K=H.getActiveScopeSpan(),L={params:R,prerenderManifest:E,renderOpts:{experimental:{authInterrupts:!!b.experimental.authInterrupts},cacheComponents:!!b.cacheComponents,supportsDynamicResponse:N,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:b.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,n,s)=>M.onRequestError(e,t,n,s,C)},sharedContext:{buildId:_}},B=new l.NodeNextRequest(e),F=new l.NodeNextResponse(t),W=u.NextRequestAdapter.fromNodeNextRequest(B,(0,u.signalFromNodeResponse)(t));try{let o=async e=>M.handle(W,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=H.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=a.get("next.route");if(n){let t=`${U} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${y}`)}),i=!!(0,s.getRequestMeta)(e,"minimalMode"),l=async s=>{var r,l;let u=async({previousCacheEntry:a})=>{try{if(!i&&S&&A&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await o(s);e.fetchMetrics=L.renderOpts.fetchMetrics;let l=L.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let u=L.renderOpts.collectedTags;if(!$)return await (0,p.sendResponse)(B,F,r,L.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(r.headers);u&&(t[f.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,n=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:n}}}}catch(t){throw(null==a?void 0:a.isStale)&&await M.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:S})},!1,C),t}},c=await M.handleResponse({req:e,nextConfig:b,cacheKey:D,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:E,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:A,responseGenerator:u,waitUntil:n.waitUntil,isMinimalMode:i});if(!$)return null;if((null==c||null==(r=c.value)?void 0:r.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",S?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let h=(0,g.fromNodeOutgoingHttpHeaders)(c.value.headers);return i&&$||h.delete(f.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||h.get("Cache-Control")||h.set("Cache-Control",(0,m.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(B,F,new Response(c.value.body,{headers:h,status:c.value.status||200})),null};K?await l(K):await H.withPropagatedContext(e.headers,()=>H.trace(c.BaseServerSpan.handleRequest,{spanName:`${U} ${y}`,kind:r.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},l))}catch(t){if(t instanceof h.NoFallbackError||await M.onRequestError(e,t,{routerKind:"App Router",routePath:T,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:S})},!1,C),$)throw t;return await (0,p.sendResponse)(B,F,new Response(null,{status:500})),null}}e.s(["handler",()=>W,"patchFetch",()=>F,"routeModule",()=>M,"serverHooks",()=>B,"workAsyncStorage",()=>K,"workUnitAsyncStorage",()=>L],43739)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_75609368.js.map