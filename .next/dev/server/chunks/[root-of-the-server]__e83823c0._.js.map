{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///home/ubuntu/.openclaw/workspaces/main/app/api/gateway-bridge/route.js"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\r\n\r\nconst supabase = createClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL,\r\n  process.env.SUPABASE_SERVICE_ROLE_KEY\r\n);\r\n\r\n// ─── Agent ID mapping (gateway agentId → internal name) ───\r\nconst AGENT_MAP = {\r\n  main: 'echo', echo: 'echo',\r\n  scout: 'scout', quill: 'quill',\r\n  sage: 'sage', sentinel: 'sentinel',\r\n  xalt: 'xalt',\r\n};\r\n\r\n// ─── Each agent has their own work room (so they spread out on the canvas) ───\r\nconst AGENT_WORK_ROOM = {\r\n  echo:     'meeting',   // Tech Lead → standup room\r\n  scout:    'research',  // Pixel UI/UX → code lab\r\n  quill:    'research',  // Dash Frontend → code lab\r\n  sage:     'board',     // Stack Backend → sprint board\r\n  sentinel: 'board',     // Probe QA → sprint board\r\n  xalt:     'research',  // Ship DevOps → code lab\r\n};\r\n\r\nconst AGENT_TALK_ROOM = {\r\n  echo:     'meeting',   // leads standup\r\n  scout:    'meeting',   // shows designs\r\n  quill:    'meeting',   // discusses with team\r\n  sage:     'meeting',   // API discussion\r\n  sentinel: 'board',     // reports bugs on board\r\n  xalt:     'board',     // deployment status\r\n};\r\n\r\nfunction getWorkRoom(agent) { return AGENT_WORK_ROOM[agent] || 'research'; }\r\nfunction getTalkRoom(agent) { return AGENT_TALK_ROOM[agent] || 'social'; }\r\n\r\n// Extract agent from gateway event payload\r\nfunction extractAgent(payload) {\r\n  if (payload?.agentId && AGENT_MAP[payload.agentId]) return AGENT_MAP[payload.agentId];\r\n  if (payload?.sessionKey) {\r\n    const parts = payload.sessionKey.split(':');\r\n    if (parts[0] === 'agent' && AGENT_MAP[parts[1]]) return AGENT_MAP[parts[1]];\r\n  }\r\n  if (payload?.data?.agentId && AGENT_MAP[payload.data.agentId]) return AGENT_MAP[payload.data.agentId];\r\n  return null;\r\n}\r\n\r\n// ─── Delegation detection — when Echo delegates, mark sub-agents as working ───\r\nconst DELEGATION_PATTERNS = {\r\n  scout:    [/pixel/i, /ui\\/ux/i, /design/i, /layout/i],\r\n  quill:    [/dash/i, /frontend/i, /html/i, /css/i, /react/i, /component/i],\r\n  sage:     [/stack/i, /backend/i, /api/i, /server/i, /database/i],\r\n  sentinel: [/probe/i, /qa/i, /bug/i, /test/i, /quality/i],\r\n  xalt:     [/ship/i, /devops/i, /deploy/i, /ci\\/cd/i, /infra/i],\r\n};\r\n\r\n// Track which sub-agents are working from a delegation\r\nconst activeDelegations = new Map(); // agentName → { startedAt, task }\r\n\r\nasync function detectDelegation(text) {\r\n  if (!text) return;\r\n  const delegationKeywords = /assign|delegat|send|dispatc|task.*to|asking|telling/i;\r\n  if (!delegationKeywords.test(text)) return;\r\n\r\n  for (const [agentId, patterns] of Object.entries(DELEGATION_PATTERNS)) {\r\n    const agentName = AGENT_MAP[agentId] || agentId;\r\n    if (patterns.some(p => p.test(text))) {\r\n      // Extract task description\r\n      const taskMatch = text.match(new RegExp(`(?:${patterns.map(p => p.source).join('|')}).*?[—–\\\\-:]\\\\s*(.{10,80})`, 'i'));\r\n      const task = taskMatch ? taskMatch[1].slice(0, 80) : 'Working on delegated task';\r\n\r\n      activeDelegations.set(agentName, { startedAt: Date.now(), task });\r\n\r\n      await supabase.from('ops_agents').update({\r\n        status: 'working',\r\n        current_task: task,\r\n        current_room: getWorkRoom(agentName),\r\n        last_active_at: new Date().toISOString(),\r\n      }).eq('name', agentName);\r\n\r\n      await supabase.from('ops_events').insert({\r\n        agent: agentName,\r\n        event_type: 'task',\r\n        title: `Delegated by Echo: ${task.slice(0, 60)}`,\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\n// When a subagent run finishes, mark delegated agents as done\r\nasync function finishDelegations() {\r\n  for (const [agentName, info] of activeDelegations.entries()) {\r\n    await supabase.from('ops_agents').update({\r\n      status: 'idle',\r\n      current_task: null,\r\n      current_room: 'desk',\r\n      last_active_at: new Date().toISOString(),\r\n    }).eq('name', agentName);\r\n\r\n    await supabase.from('ops_events').insert({\r\n      agent: agentName,\r\n      event_type: 'complete',\r\n      title: 'Completed delegated task',\r\n    });\r\n  }\r\n  activeDelegations.clear();\r\n}\r\n\r\n// ─── Track active runs (per agent, per request) ───\r\nconst activeRuns = new Map(); // runId → { agent, text, startedAt, toolCalls, chatLogged, recovered }\r\n\r\n// ─── Stuck run watchdog — REAL: just marks agent as timed out, no fake conversations ───\r\nconst STUCK_TIMEOUT_MS = 120_000; // 2 minutes\r\nlet watchdogInterval = null;\r\n\r\nfunction startWatchdog() {\r\n  if (watchdogInterval) return;\r\n  watchdogInterval = setInterval(async () => {\r\n    const now = Date.now();\r\n    for (const [runId, run] of activeRuns.entries()) {\r\n      if (run.recovered) continue;\r\n      const age = now - run.startedAt;\r\n      if (age > STUCK_TIMEOUT_MS) {\r\n        run.recovered = true;\r\n        console.log(`[Watchdog] Run ${runId} timed out after ${Math.round(age / 1000)}s`);\r\n\r\n        // Return the stuck agent to idle — no fake recovery drama\r\n        await supabase.from('ops_agents').update({\r\n          status: 'idle',\r\n          current_task: null,\r\n          current_room: 'desk',\r\n          last_active_at: new Date().toISOString(),\r\n        }).eq('name', run.agent);\r\n\r\n        await supabase.from('ops_events').insert({\r\n          agent: run.agent,\r\n          event_type: 'alert',\r\n          title: `Run timed out after ${Math.round(age / 1000)}s`,\r\n        });\r\n\r\n        setTimeout(() => activeRuns.delete(runId), 5000);\r\n      }\r\n    }\r\n  }, 15_000);\r\n}\r\nstartWatchdog();\r\n\r\n// ─── Room command detection ───\r\n// Detects messages like \"Echo come to coffee room\", \"everyone go to standup\", etc.\r\nconst ROOM_ALIASES = {\r\n  'desk': ['desk', 'desks', 'dev floor', 'devfloor', 'work'],\r\n  'meeting': ['meeting', 'standup', 'stand up', 'stand-up', 'huddle', 'social', 'chat', 'chat room', 'lounge'],\r\n  'research': ['research', 'lab', 'code lab', 'codelab'],\r\n  'board': ['board', 'sprint', 'sprint board', 'sprintboard', 'kanban', 'break', 'coffee'],\r\n};\r\n\r\nconst AGENT_NAME_MAP = {\r\n  echo: 'echo', pixel: 'scout', dash: 'quill', stack: 'sage',\r\n  probe: 'sentinel', ship: 'xalt',\r\n  // also accept internal IDs\r\n  scout: 'scout', quill: 'quill', sage: 'sage', sentinel: 'sentinel', xalt: 'xalt',\r\n};\r\n\r\nconst ALL_KEYWORDS = ['everyone', 'all', 'team', 'all agents', 'everybody', 'guys', 'y\\'all', 'yall'];\r\n\r\nasync function detectRoomCommand(text) {\r\n  if (!text) return null;\r\n  const lower = text.toLowerCase().trim();\r\n\r\n  // Check if it looks like a room command\r\n  const movePatterns = /(?:come|go|move|head|get|walk|report)\\s+(?:to|over\\s+to|into|in)?\\s*/i;\r\n  const goToPattern = /(?:go\\s+to|come\\s+to|move\\s+to|head\\s+to|report\\s+to|get\\s+to|walk\\s+to)\\s+/i;\r\n\r\n  if (!movePatterns.test(lower) && !goToPattern.test(lower)) return null;\r\n\r\n  // Find target room\r\n  let targetRoom = null;\r\n  for (const [roomId, aliases] of Object.entries(ROOM_ALIASES)) {\r\n    for (const alias of aliases) {\r\n      if (lower.includes(alias)) {\r\n        targetRoom = roomId;\r\n        break;\r\n      }\r\n    }\r\n    if (targetRoom) break;\r\n  }\r\n  if (!targetRoom) return null;\r\n\r\n  // Find target agents\r\n  let targetAgents = [];\r\n\r\n  // Check for \"everyone/all\" first\r\n  if (ALL_KEYWORDS.some(k => lower.includes(k))) {\r\n    targetAgents = ['echo', 'scout', 'quill', 'sage', 'sentinel', 'xalt'];\r\n  } else {\r\n    // Check for specific agent names\r\n    for (const [name, id] of Object.entries(AGENT_NAME_MAP)) {\r\n      if (lower.includes(name)) {\r\n        if (!targetAgents.includes(id)) targetAgents.push(id);\r\n      }\r\n    }\r\n  }\r\n\r\n  if (targetAgents.length === 0) return null;\r\n\r\n  // Execute the move\r\n  for (const agentId of targetAgents) {\r\n    await supabase\r\n      .from('ops_agents')\r\n      .update({ current_room: targetRoom })\r\n      .eq('name', agentId);\r\n  }\r\n\r\n  return { agents: targetAgents, room: targetRoom };\r\n}\r\n\r\n// ─── Team dispatch detection (logging only — actual dispatch happens on EC2) ───\r\nconst ALL_AGENTS = ['scout', 'quill', 'sage', 'sentinel', 'xalt'];\r\n\r\nconst TEAM_TRIGGERS = [\r\n  'roll call', 'rollcall', 'team report', 'status report', 'team check',\r\n  'everyone report', 'all agents', 'team standup', 'standup', 'check in',\r\n  'who\\'s here', 'whos here', 'who is here', 'sound off', 'report in',\r\n];\r\n\r\nconst AGENT_DISPATCH_MAP = {\r\n  pixel: 'scout', dash: 'quill', stack: 'sage', probe: 'sentinel', ship: 'xalt',\r\n};\r\n\r\n// Detect team/single dispatch commands (EC2 bridge handles the actual dispatch)\r\nfunction detectTeamDispatch(text) {\r\n  if (!text) return null;\r\n  const lower = text.toLowerCase().trim();\r\n\r\n  if (TEAM_TRIGGERS.some(t => lower.includes(t))) {\r\n    return { type: 'team', agents: ALL_AGENTS };\r\n  }\r\n\r\n  for (const [name, agentId] of Object.entries(AGENT_DISPATCH_MAP)) {\r\n    const patterns = [`@${name}`, `hey ${name}`, `yo ${name}`, `${name},`];\r\n    if (patterns.some(p => lower.includes(p))) {\r\n      return { type: 'single', agents: [agentId] };\r\n    }\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\n// ─── Process REAL OpenClaw gateway events ───\r\n// Only the agent that ACTUALLY receives the gateway event gets updated.\r\n// No fake collaborators, no simulated inter-agent messages.\r\n// OpenClaw routes ONE message to ONE agent — that's the reality.\r\nasync function processGatewayMessage(msg) {\r\n  try {\r\n    // Handle bridge-level events (not from gateway)\r\n    if (msg.type === 'node:connected' || msg.type === 'node:disconnected') {\r\n      await supabase.from('ops_events').insert({\r\n        agent: 'system',\r\n        event_type: 'system',\r\n        title: msg.type === 'node:connected' ? 'Bridge connected to gateway' : `Bridge disconnected (${msg.message || ''})`,\r\n      });\r\n      return { type: msg.type };\r\n    }\r\n\r\n    if (msg.type !== 'event') return null;\r\n\r\n    const eventName = msg.event;\r\n    const payload = msg.payload || {};\r\n    const agent = extractAgent(payload) || 'echo';\r\n    const runId = payload.runId;\r\n\r\n    // ── lifecycle:start — ONE agent starts processing a request ──\r\n    if (eventName === 'agent' && payload.stream === 'lifecycle' && payload.data?.phase === 'start') {\r\n      const isSubagent = payload.sessionKey?.includes('subagent');\r\n\r\n      if (runId) {\r\n        activeRuns.set(runId, {\r\n          agent, text: '', startedAt: Date.now(),\r\n          toolCalls: [], chatLogged: false, recovered: false,\r\n          isSubagent,\r\n        });\r\n      }\r\n\r\n      await supabase.from('ops_agents').update({\r\n        status: 'working',\r\n        current_task: isSubagent ? 'Working on delegated sub-task...' : 'Processing request...',\r\n        current_room: getWorkRoom(agent),\r\n        last_active_at: new Date().toISOString(),\r\n      }).eq('name', agent);\r\n\r\n      await supabase.from('ops_events').insert({\r\n        agent,\r\n        event_type: 'task',\r\n        title: isSubagent ? 'Sub-agent started working' : 'Started processing request',\r\n      });\r\n\r\n      return { type: 'lifecycle_start', agent, isSubagent };\r\n    }\r\n\r\n    // ── lifecycle:end — ONE agent finishes processing ──\r\n    if (eventName === 'agent' && payload.stream === 'lifecycle' && payload.data?.phase === 'end') {\r\n      const run = runId ? activeRuns.get(runId) : null;\r\n      const isSubagent = run?.isSubagent || payload.sessionKey?.includes('subagent');\r\n\r\n      // Save the final real response as a message\r\n      if (run?.text) {\r\n        await supabase.from('ops_messages').insert({\r\n          from_agent: agent,\r\n          to_agent: 'user',\r\n          message: run.text.slice(0, 1500),\r\n        });\r\n      }\r\n\r\n      // Return ONLY this agent to idle\r\n      await supabase.from('ops_agents').update({\r\n        status: 'idle',\r\n        current_task: null,\r\n        current_room: 'desk',\r\n        last_active_at: new Date().toISOString(),\r\n      }).eq('name', agent);\r\n\r\n      await supabase.from('ops_events').insert({\r\n        agent,\r\n        event_type: 'complete',\r\n        title: `Completed${run?.toolCalls.length ? ` (${run.toolCalls.length} tools used)` : ''}`,\r\n      });\r\n\r\n      // If this is a subagent ending, mark delegated agents as completed too\r\n      if (isSubagent) {\r\n        await finishDelegations();\r\n      }\r\n\r\n      if (runId) setTimeout(() => activeRuns.delete(runId), 5000);\r\n      return { type: 'lifecycle_end', agent, isSubagent };\r\n    }\r\n\r\n    // ── assistant — Streaming response (accumulate text, update ONLY this agent) ──\r\n    if (eventName === 'agent' && payload.stream === 'assistant') {\r\n      const text = payload.data?.text || '';\r\n      if (!text) return null;\r\n\r\n      // Accumulate text for this run\r\n      if (runId) {\r\n        const run = activeRuns.get(runId);\r\n        if (run) run.text = text; // gateway sends full accumulated text\r\n      }\r\n\r\n      // Update ONLY the agent that's actually responding\r\n      const preview = text.length > 80 ? text.slice(0, 80) + '...' : text;\r\n      await supabase.from('ops_agents').update({\r\n        status: 'talking',\r\n        current_task: `Responding: \"${preview}\"`,\r\n        current_room: getTalkRoom(agent),\r\n        last_active_at: new Date().toISOString(),\r\n      }).eq('name', agent);\r\n\r\n      // Detect delegation in Echo's response\r\n      if (agent === 'echo') {\r\n        await detectDelegation(text);\r\n      }\r\n\r\n      return { type: 'assistant_stream', agent };\r\n    }\r\n\r\n    // ── tool-call — ONLY this agent is using a tool ──\r\n    if (eventName === 'agent' && payload.stream === 'tool-call') {\r\n      const toolName = payload.data?.name || payload.data?.tool || 'unknown';\r\n\r\n      if (runId) {\r\n        const run = activeRuns.get(runId);\r\n        if (run) run.toolCalls.push(toolName);\r\n      }\r\n\r\n      await supabase.from('ops_agents').update({\r\n        status: 'working',\r\n        current_task: `Using: ${toolName}`,\r\n        current_room: getWorkRoom(agent),\r\n        last_active_at: new Date().toISOString(),\r\n      }).eq('name', agent);\r\n\r\n      await supabase.from('ops_events').insert({\r\n        agent,\r\n        event_type: 'task',\r\n        title: `Tool: ${toolName}`,\r\n      });\r\n\r\n      return { type: 'tool_call', agent, tool: toolName };\r\n    }\r\n\r\n    // ── tool-result — Tool returned a result ──\r\n    if (eventName === 'agent' && payload.stream === 'tool-result') {\r\n      await supabase.from('ops_events').insert({\r\n        agent,\r\n        event_type: 'complete',\r\n        title: 'Tool result received',\r\n      });\r\n      return { type: 'tool_result', agent };\r\n    }\r\n\r\n    // ── chat — User message received (store REAL user message) ──\r\n    if (eventName === 'chat') {\r\n      const run = runId ? activeRuns.get(runId) : null;\r\n      if (run?.chatLogged) return null;\r\n      if (run) run.chatLogged = true;\r\n\r\n      const text = payload.data?.text || payload.text || payload.content || '';\r\n\r\n      // Check for room movement commands\r\n      const roomCmd = await detectRoomCommand(text);\r\n      if (roomCmd) {\r\n        await supabase.from('ops_events').insert({\r\n          agent: 'system',\r\n          event_type: 'move',\r\n          title: `${roomCmd.agents.join(', ')} → ${roomCmd.room}`,\r\n        });\r\n      }\r\n\r\n      // Check for team dispatch commands (log it — EC2 bridge handles actual dispatch)\r\n      const dispatch = detectTeamDispatch(text);\r\n      if (dispatch) {\r\n        await supabase.from('ops_events').insert({\r\n          agent: 'system',\r\n          event_type: 'dispatch',\r\n          title: `Dispatching ${dispatch.type}: ${dispatch.agents.join(', ')}`,\r\n        });\r\n      }\r\n\r\n      // Store the user's REAL message\r\n      if (text) {\r\n        await supabase.from('ops_messages').insert({\r\n          from_agent: 'user',\r\n          to_agent: agent,\r\n          message: text.slice(0, 1500),\r\n        });\r\n      }\r\n\r\n      await supabase.from('ops_events').insert({\r\n        agent,\r\n        event_type: 'chat',\r\n        title: `Message: ${(text || '...').slice(0, 80)}`,\r\n      });\r\n\r\n      return { type: 'chat', agent };\r\n    }\r\n\r\n    return null;\r\n  } catch (err) {\r\n    console.error('[Bridge] Error:', err.message);\r\n    return null;\r\n  }\r\n}\r\n\r\n// GET — Bridge status\r\nexport async function GET() {\r\n  return Response.json({\r\n    status: 'ready',\r\n    gateway: process.env.OPENCLAW_GATEWAY_URL || 'ws://localhost:18789',\r\n    agents: [...new Set(Object.values(AGENT_MAP))],\r\n    activeRuns: activeRuns.size,\r\n    timestamp: new Date().toISOString(),\r\n  });\r\n}\r\n\r\n// POST — Receive gateway events\r\nexport async function POST(request) {\r\n  try {\r\n    const body = await request.json();\r\n\r\n    if (body.type && !body.events) {\r\n      const result = await processGatewayMessage(body);\r\n      return Response.json({ ok: true, processed: result ? 1 : 0, result });\r\n    }\r\n\r\n    if (Array.isArray(body.events)) {\r\n      const results = [];\r\n      for (const evt of body.events) {\r\n        const r = await processGatewayMessage(evt);\r\n        if (r) results.push(r);\r\n      }\r\n      return Response.json({ ok: true, processed: results.length, results });\r\n    }\r\n\r\n    return Response.json({ ok: false, error: 'Invalid payload' }, { status: 400 });\r\n  } catch (err) {\r\n    console.error('[Bridge API] Error:', err.message);\r\n    return Response.json({ ok: false, error: err.message }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}